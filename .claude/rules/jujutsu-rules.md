# Jujutsu (jj) Rules

このプロジェクトではバージョン管理に **Jujutsu (jj)** を使用する。**`git` コマンドは原則使用禁止**（`jj git` サブコマンドを除く）。

---

## ⚠️ AI アシスタント向け重要注意

### 絶対に使ってはいけない用語・概念

| ❌ 禁止（Git 用語）    | ✅ 使用すべき（Jujutsu 用語） |
| ---------------------- | ----------------------------- |
| commit（名詞として）   | change / 変更セット           |
| branch                 | bookmark                      |
| unstaged changes       | （この概念は存在しない）      |
| uncommitted changes    | （この概念は存在しない）      |
| 未保存の変更           | （この概念は存在しない）      |
| staging / ステージング | （この概念は存在しない）      |

### Jujutsu の根本的な違い（必ず理解すること）

1. **「未保存の変更」は存在しない**
   - Jujutsu では、ファイルを保存した瞬間に現在の change（`@`）に自動的に含まれる
   - 「この変更を含めますか？」という質問は無意味。すべての変更は常に含まれている
   - `jj status` で確認できるのは「現在の change の内容」であり、「未保存の変更」ではない

2. **change と commit/revision の関係**
   - **change**: 作業単位。一意の change ID を持つ。内容は可変
   - **commit / revision**: change のある時点でのスナップショット。commit ID で識別。イミュータブル
   - change を編集すると、新しい commit/revision が作られるが、change ID は変わらない
   - Git なら「5 つのコミット」と表現するところを Jujutsu では「5 つの change」と表現すること

3. **bookmark が付いた change はそのまま push 可能**
   - bookmark（Git の branch に相当）が設定されていれば、追加の操作なしに push できる
   - 「コミットしますか？」という確認は不要

---

## Git との主な違い

1. **ステージングエリア（Index）は存在しない**: `jj` では、作業ディレクトリ内のファイルの保存が即座に現在の変更セット（`@`）に反映される。`git add` に相当する操作は不要であり、試みてはならない。
2. **自動保存と自動整形**: ファイルの変更は自動的に追跡される。また、コミット時には `jj fix` がフックにより自動実行され、コードが整形される。

| Git の概念   | Jujutsu の概念                               |
| ------------ | -------------------------------------------- |
| commit       | change (変更セット)                          |
| branch       | bookmark                                     |
| staging area | なし（作業コピーが自動的に変更セットになる） |
| HEAD         | `@`（現在の作業コピー）                      |
| HEAD~1       | `@-`                                         |

---

## 基本ワークフロー

### 1. 状態確認

```bash
jj status          # 作業コピーの状態
jj log             # 変更履歴（デフォルトで見やすいグラフ表示）
jj log -r @        # 現在の変更セットのみ表示
```

### 2. 差分確認

```bash
jj diff            # 作業コピーの差分
jj diff -r @-      # 一つ前の変更セットの差分
jj diff --from @- --to @  # 前の変更セットとの比較
```

### 3. 変更の記録

```bash
# 現在の変更セットにメッセージを設定
jj describe -m "feat: 新機能を追加"

# 新しい変更セットを開始（describe 後に実行）
jj new

# 一度にメッセージ設定と新規作成
jj commit -m "feat: 新機能を追加"
```

### 4. ブックマーク（ブランチ相当）の操作

```bash
# 現在の変更セットにブックマークを設定
jj bookmark set <name> -r @

# ブックマーク一覧
jj bookmark list

# ブックマークの移動
jj bookmark set <name> -r <revision>
```

### 5. リモート操作

```bash
# 特定のブックマークをプッシュ（本来ならコマンドは `jj git push` だが、一連の pre-push タスクを事前に実行するよう定義したエイリアスコマンド `jj push` を使う）
jj push -b <name>

# フェッチ
jj git fetch

# フェッチ後にリモートの変更を取り込む
jj git fetch && jj rebase -o <bookmark>@origin
```

---

## よく使う操作

### 変更の取り消し

```bash
# 作業コピーの変更を破棄
jj restore

# 特定のファイルのみ復元
jj restore <path>

# 変更セットを破棄
jj abandon @
```

### 履歴の編集

```bash
# 過去の変更セットを編集
jj edit <revision>

# 変更セットの順序入れ替え・統合
jj rebase -r <revision> -o <target>

# 複数の変更セットを一つに統合（作業中の整理目的のみ。PR 前の squash は禁止）
jj squash
```

### 一時退避（stash 相当）

```bash
# jj では不要：新しい変更セットを作るだけ
jj new

# 別の作業に移動
jj edit <revision>

# 元に戻る
jj edit <original-revision>
```

### コンフリクト解決

Jujutsu ではコンフリクトが発生しても操作は中断されず、ファイル内にマーカーが挿入された状態でコミットが可能になる。AI は以下の手順で解決すること。

1. `jj status` でコンフリクトしているファイルを確認する。
2. エディタで対象ファイルを開き、コンフリクトマーカー（`<<<<<<<`, `=======`, `>>>>>>>`）を含む箇所を**直接編集して正しい状態に書き換える**。
3. ファイルを保存する。`jj` が自動的にコンフリクト解消を検知する。
4. `jj status` でコンフリクトが解消されたことを確認する。

---

## リビジョン指定の記法

| 記法                | 意味                   |
| ------------------- | ---------------------- |
| `@`                 | 現在の作業コピー       |
| `@-`                | 一つ前の変更セット     |
| `@--`               | 二つ前の変更セット     |
| `<bookmark>`        | ブックマーク名で指定   |
| `<bookmark>@origin` | リモートのブックマーク |
| `root()`            | リポジトリのルート     |

---

## PR 作成ワークフロー

### 基本ルール

1. **ターゲットは常に `main`** - 特に指示がない限り、PR のターゲットブランチは `main` とする。確認は不要
2. **squash は禁止** - 複数の change を 1 つにまとめてはならない。変更履歴の追跡可能性を維持するため、各 change はそのまま保持する
3. **確認不要な事項** - 以下について毎回ユーザーに確認する必要はない：
   - 「変更を含めますか？」→ 常に含まれている
   - 「main にマージしますか？」→ 特に指示がなければ main
   - 「squash しますか？」→ しない

### PR 作成手順

```bash
# 1. 現在の状態を確認
jj log

# 2. bookmark が設定されていることを確認
jj bookmark list

# 3. リモートに push
jj push -b <bookmark-name>

# 4. GitHub CLI で PR 作成
gh pr create --base main --head <bookmark-name>
```

### PR 作成時にやってはいけないこと

- ❌ 「未保存の変更があります」と報告する
- ❌ squash するかどうかを確認する
- ❌ ターゲットブランチを毎回確認する
- ❌ 「コミット」という用語を使う

---

## 注意事項

1. **自動保存**: jj は作業ディレクトリの変更を自動的に追跡する。明示的な `add` は不要。
2. **イミュータブル履歴**: デフォルトでは公開済みの変更セットは不変。ローカルの変更は自由に編集可能。
3. **コンフリクトの扱い**: jj はコンフリクトを含む変更セットもコミット可能。後から解決できる。
4. **Git 互換**: `.git` ディレクトリと共存可能。`jj git push/fetch` で Git リモートと連携。
